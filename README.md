# ü§ñ MOEX Trading Bot

–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–ª—è MOEX —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Ä–æ–≤–Ω–µ–π –î–æ–Ω—á–µ–Ω–Ω–µ–ª–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Telegram.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- [–ó–∞–ø—É—Å–∫](#–∑–∞–ø—É—Å–∫)
- [Docker](#docker)
- [–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
- [–î–µ–ø–ª–æ–π](#–¥–µ–ø–ª–æ–π)
- [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- [Troubleshooting](#troubleshooting)

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üìä –ê–Ω–∞–ª–∏–∑ —É—Ä–æ–≤–Ω–µ–π –î–æ–Ω—á–µ–Ω–Ω–µ–ª–∞ –¥–ª—è –∞–∫—Ü–∏–π MOEX
- ü§ñ Telegram –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üìà –°–∏–º—É–ª—è—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ (–±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥)
- üîÑ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
- üõ°Ô∏è Graceful shutdown –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- üê≥ Docker ready
- üîç Health checks

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js >= 20.0.0
- npm >= 9.0.0
- Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- PM2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω –¥–µ–ø–ª–æ—è)

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd moex-donchian-levels
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª –∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–∏ credentials:

```env
TG_BOT_TOKEN=your_telegram_bot_token
TG_CHAT_ID=your_chat_id
ALOR_REFRESH_TOKEN=your_alor_token
ALOR_CLIENT=your_client_id
ALOR_PORTFOLIO=your_portfolio
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `TG_BOT_TOKEN` | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | - |
| `TG_CHAT_ID` | ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | - |
| `ALOR_REFRESH_TOKEN` | Refresh token Alor API | - |
| `ALOR_CLIENT` | Client ID Alor | - |
| `ALOR_PORTFOLIO` | Portfolio ID Alor | - |
| `NODE_ENV` | –û–∫—Ä—É–∂–µ–Ω–∏–µ | `development` |
| `PORT` | –ü–æ—Ä—Ç –¥–ª—è health check | `3000` |
| `LOG_LEVEL` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `info` |
| `MOCK_MODE` | –†–µ–∂–∏–º –º–æ–∫–æ–≤ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API) | `false` |
| `MOEX_API_TIMEOUT` | –¢–∞–π–º–∞—É—Ç MOEX API (–º—Å) | `10000` |
| `ALOR_API_TIMEOUT` | –¢–∞–π–º–∞—É—Ç Alor API (–º—Å) | `15000` |

## üèÉ –ó–∞–ø—É—Å–∫

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
npm run dev
```

### –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º. –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∞ –æ—Ä–¥–µ—Ä–æ–≤ –∏ Telegram-–±–æ—Ç–∞

```bash
npm run build
pm2 start ecosystem-app.config.cjs
pm2 start ecosystem-bot.config.cjs

```

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
npm run bot
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤

```bash
npm run orders
```

## üê≥ Docker

### –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```bash
npm run docker:build
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
npm run docker:up
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
npm run docker:down
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
npm run docker:logs
```

### Docker Compose (–ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫)

```bash
docker-compose up -d
```

## üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ bot/                  # Telegram –±–æ—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alor/            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Alor API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history/         # –†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ instruments/     # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–∏–∫–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sessions/        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ config/              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ health/              # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ order-state/         # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ sim-trade/           # –°–∏–º—É–ª—è—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ utils/               # –£—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ data/                     # –î–∞–Ω–Ω—ã–µ (–Ω–µ –≤ git)
‚îú‚îÄ‚îÄ logs/                     # –õ–æ–≥–∏ (–Ω–µ –≤ git)
‚îú‚îÄ‚îÄ Dockerfile               # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml       # Docker Compose
‚îî‚îÄ‚îÄ ecosystem.config.cjs     # PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

### –°–∫—Ä–∏–ø—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –°–±–æ—Ä–∫–∞
npm run build

# –û—á–∏—Å—Ç–∫–∞ dist
npm run clean

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
npm run rebuild

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
npm run type-check

# –õ–∏–Ω—Ç–∏–Ω–≥
npm run lint

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
npm run format
```

## üöÄ –î–µ–ø–ª–æ–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: PM2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
npm install -g pm2

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
npm run build

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
npm run pm2:start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
npm run pm2:stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
npm run pm2:restart

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
npm run pm2:logs

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
npm run pm2:monit
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Systemd

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/systemd/system/moex-bot.service`:

```ini
[Unit]
Description=MOEX Trading Bot
After=network.target

[Service]
Type=simple
User=bot
WorkingDirectory=/path/to/moex-donchian-levels
Environment=NODE_ENV=production
ExecStart=/usr/bin/node dist/bot/main.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

–ó–∞—Ç–µ–º:

```bash
sudo systemctl daemon-reload
sudo systemctl enable moex-bot
sudo systemctl start moex-bot
sudo systemctl status moex-bot
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Docker

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞
docker-compose ps

# –õ–æ–≥–∏
docker-compose logs -f bot
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check Endpoints

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

- `GET /health` - –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- `GET /ready` - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- `GET /live` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü—Ä–∏–º–µ—Ä:

```bash
curl http://localhost:3000/health
```

–û—Ç–≤–µ—Ç:

```json
{
  "status": "ok",
  "timestamp": "2024-02-14T12:00:00.000Z",
  "uptime": 3600,
  "version": "2.0.0",
  "services": {
    "moex": "ok",
    "telegram": "ok",
    "alor": "ok"
  }
}
```

### –õ–æ–≥–∏

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `logs/`:

- `application-YYYY-MM-DD.log` - –í—Å–µ –ª–æ–≥–∏
- `error-YYYY-MM-DD.log` - –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
- `pm2-out.log` - Stdout (–ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ PM2)
- `pm2-error.log` - Stderr (–ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ PM2)

–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ö—Ä–∞–Ω—è—Ç—Å—è 14 –¥–Ω–µ–π –¥–ª—è application, 30 –¥–Ω–µ–π –¥–ª—è error).

### PM2 Monitoring

```bash
# Dashboard
pm2 monit

# –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 list

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
pm2 show moex-bot

# –õ–æ–≥–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
pm2 logs moex-bot
```

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "timeout of 10000ms exceeded"

**–ü—Ä–∏—á–∏–Ω–∞:** MOEX API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è: `date`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MOEX API: `curl https://iss.moex.com/iss/index.json`
3. –í—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç–µ MOCK —Ä–µ–∂–∏–º: `MOCK_MODE=true npm start`

### –ü—Ä–æ–±–ª–µ–º–∞: "Missing required environment variables"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω .env —Ñ–∞–π–ª

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env`
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
3. –ò–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ `MOCK_MODE=true` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Telegram

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TG_BOT_TOKEN` –≤ .env
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `npm run pm2:logs` –∏–ª–∏ `docker-compose logs -f`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –∏ —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs bot`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check: `docker-compose ps`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ .env —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìù Changelog

### Version 2.0.0

- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω Docker support
- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω—ã health check endpoints
- ‚ú® –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Winston)
- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω graceful shutdown
- ‚ú® –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ .env
- üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤ historyIncremental
- üêõ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ MOEX API
- üîí –°–µ–∫—Ä–µ—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

## üìÑ License

MIT

## ü§ù Contributing

Pull requests are welcome!

## üìß Support

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
